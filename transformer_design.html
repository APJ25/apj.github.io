<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Transformer Design with AI Advisor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
        }
        .katex {
            font-size: 1.1em;
        }
        h2 {
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
            margin-top: 2rem;
            margin-bottom: 1.5rem;
            font-size: 1.75rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h3 {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .equation {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #f1f5f9;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
            overflow-x: auto;
        }
        .equation-label {
            color: #64748b;
            font-weight: 500;
            margin-left: 1.5rem;
        }
        .ai-button {
            background-color: #4f46e5;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.3s;
            cursor: pointer;
        }
        .ai-button:hover {
            background-color: #4338ca;
        }
        .ai-button:disabled {
            background-color: #a5b4fc;
            cursor: not-allowed;
        }
        .explain-button {
            background: none;
            border: 1px solid #c7d2fe;
            color: #4f46e5;
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .explain-button:hover {
            background-color: #e0e7ff;
        }
        /* Modal styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 90%;
            width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .loader {
            width: 20px;
            height: 20px;
            border: 3px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* NEW STYLES FOR THE EXPLANATION SECTIONS */
        .explanation-section {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .explanation-section:last-of-type {
            border-bottom: none;
        }
        .explanation-section h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 1rem;
            text-align: center; /* Center these main headings */
        }
        .explanation-section h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #334155;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .explanation-section p {
            margin-bottom: 1rem;
            line-height: 1.7;
        }
    </style>
</head>
<body>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-800">Magnetic Optimization of RPSFB for Railway Application</h1>
            <p class="text-lg text-slate-600 mt-2">An Interactive Guide with AI-Powered Design Tools</p>
        </header>

        <div class="explanation-section">
            <h2>Introduction to High-Frequency Transformer Design</h2>
            [cite_start]<p>High-frequency transformers are indispensable components in modern power converters, particularly in isolated DC-DC topologies like the Phase-Shift Full Bridge (PSFB) converter used in railway applications. [cite: 28] [cite_start]Their design critically influences the overall efficiency, power density, and thermal performance of the converter. [cite: 29] [cite_start]This section details the theoretical foundations, design considerations, and calculation methodologies employed to optimize the transformer for our reconfigurable PSFB converter, complementing the interactive analysis tool below. [cite: 30]</p>
            [cite_start]<p>The primary goal was to achieve a robust and efficient magnetic component capable of handling varying input voltages and output power requirements while minimizing losses and maintaining acceptable thermal performance within a constrained volume. [cite: 30]</p>
        </div>

        <div class="explanation-section">
            <h2>Core Selection and Material Properties</h2>
            [cite_start]<p>The selection of an appropriate magnetic core material and geometry is the first critical step in transformer design. [cite: 31] [cite_start]Core losses are highly dependent on the material's properties (such as saturation flux density and loss coefficients) and the operating frequency and peak flux density. [cite: 31] [cite_start]For high-frequency applications, ferrite materials are typically chosen due to their low losses at elevated frequencies. [cite: 32]</p>
            [cite_start]<p>The calculations below utilize parameters for various common ferrite core types, allowing for a comparative analysis to identify the most suitable core for a given set of operating conditions. [cite: 33] [cite_start]Key parameters considered for each core include: [cite: 33]</p>
            <ul>
                [cite_start]<li><strong>Effective Area ($A_e$)</strong>: The cross-sectional area through which the magnetic flux passes. [cite: 33]</li>
                [cite_start]<li><strong>Effective Magnetic Path Length ($l_e$)</strong>: The average length of the magnetic flux path. [cite: 33]</li>
                [cite_start]<li><strong>Window Area ($W_a$)</strong>: The area available for winding turns. [cite: 33]</li>
                [cite_start]<li><strong>Mean Length Per Turn (MLT)</strong>: The average length of a single winding turn. [cite: 33]</li>
                [cite_start]<li><strong>Thermal Resistance ($R_{th}$)</strong>: A measure of the core's ability to dissipate heat. [cite: 33]</li>
            </ul>
            [cite_start]<p>These parameters are fundamental for calculating flux density, winding lengths, and thermal performance. [cite: 33]</p>
        </div>

        <div class="explanation-section">
            <h2>Fundamental Design Equations</h2>
            [cite_start]<p>The transformer design process involves several iterative calculations to determine optimal turns, wire gauges, and minimize losses. [cite: 34] [cite_start]The core equations governing transformer operation are derived from Faraday's Law of Induction and principles of current density and power loss. [cite: 34]</p>

            <h3>Faraday's Law for Primary Turns Calculation:</h3>
            [cite_start]<p>The minimum number of primary turns ($N_p$) is crucial to prevent core saturation. [cite: 35] [cite_start]It is inversely proportional to the maximum operating flux density ($B_{max}$), switching frequency ($f$), and effective core area ($A_e$). [cite: 36] [cite_start]For a unipolar flux swing (e.g., in a push-pull or full-bridge configuration): [cite: 36]</p>
            <div class="equation"><span id="eq_Np"></span><span class="equation-label"></span></div>
            <p>Where: <br>
            [cite_start]$V_{in}$ is the input voltage across the primary winding (peak voltage for AC, or DC voltage for square-wave driven primary). [cite: 36]<br>
            [cite_start]$f$ is the switching frequency. [cite: 36]<br>
            [cite_start]$B_{max}$ is the maximum allowable peak flux density in the core (dependent on material and temperature). [cite: 36]<br>
            [cite_start]$A_e$ is the effective cross-sectional area of the core. [cite: 37]</p>

            <h3>Turns Ratio and Secondary Turns:</h3>
            [cite_start]<p>The turns ratio ($n = N_p / N_s$) determines the voltage transformation. [cite: 38] [cite_start]The number of secondary turns ($N_s$) is then simply $N_s = N_p / n$. [cite: 39] [cite_start]The turns ratio also considers voltage drops across rectifiers and desired output voltage. [cite: 39]</p>
            <div class="equation"><span id="eq_n"></span><span class="equation-label"></span></div>

            <h3>Core Loss Calculation (Steinmetz Equation):</h3>
            [cite_start]<p>Core losses ($P_{core}$) primarily arise from hysteresis and eddy currents within the magnetic material. [cite: 40] [cite_start]These are typically modeled using a modified Steinmetz equation: [cite: 40]</p>
            <div class="equation"><span id="eq_Pcore"></span><span class="equation-label"></span></div>
            <p>Where: <br>
            [cite_start]$k, \alpha, \beta$ are Steinmetz coefficients specific to the core material. [cite: 41]<br>
            [cite_start]$f$ is the switching frequency. [cite: 41]<br>
            [cite_start]$B_{ac}$ is the peak-to-peak AC flux density swing. [cite: 41]<br>
            [cite_start]$V_e$ is the effective core volume ($A_e \cdot l_e$). [cite: 41]</p>

            <h3>Copper Loss Calculation:</h3>
            [cite_start]<p>Copper losses ($P_{copper}$) occur in the windings due to the resistance of the wire. [cite: 42] [cite_start]At high frequencies, these losses are significantly exacerbated by <strong>skin effect</strong> (current concentrating near the conductor surface) and <strong>proximity effect</strong> (current redistribution due to adjacent magnetic fields). [cite: 42] [cite_start]These effects increase the effective AC resistance ($R_{ac}$) of the winding compared to its DC resistance ($R_{dc}$). [cite: 43]</p>
            <div class="equation"><span id="eq_Pcopper"></span><span class="equation-label"></span></div>
            <br>
            [cite_start]<p>The AC resistance ($R_{ac}$) is related to the DC resistance ($R_{dc}$) by the factor $F_R$: [cite: 43]</p>
            <div class="equation"><span id="eq_Rac"></span><span class="equation-label"></span></div>
            [cite_start]<p>Where $F_R$ accounts for skin and proximity effects, calculated using more complex models (e.g., Dowell's curves), which depend on wire diameter, frequency, and winding geometry. [cite: 44]</p>

            <h3>Total Power Loss:</h3>
            [cite_start]<p>The total power loss in the transformer is the sum of the core and copper losses: [cite: 44]</p>
            <div class="equation"><span id="eq_Ptotalloss"></span><span class="equation-label"></span></div>
            [cite_start]<p>This total loss directly contributes to the temperature rise of the transformer. [cite: 44]</p>
        </div>

        <div class="card bg-indigo-50 border-2 border-indigo-200">
            <h2 id="ai-advisor" class="text-indigo-800">✨ AI Design Advisor</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                <div><label class="font-medium">Input Voltage (Vin)</label><input id="vin" type="number" value="80" class="w-full p-2 border rounded mt-1"></div>
                <div><label class="font-medium">Duty Cycle (D)</label><input id="d" type="number" value="0.4" step="0.01" class="w-full p-2 border rounded mt-1"></div>
                <div><label class="font-medium">Frequency (fs, kHz)</label><input id="fs" type="number" value="100" class="w-full p-2 border rounded mt-1"></div>
                <div><label class="font-medium">Core Area (Ac, mm²)</label><input id="ac" type="number" value="127" class="w-full p-2 border rounded mt-1"></div>
                <div><label class="font-medium">Max Flux (Bmax, T)</label><input id="bmax" type="number" value="0.3" step="0.01" class="w-full p-2 border rounded mt-1"></div>
                <div><label class="font-medium">Output Current (Io, A)</label><input id="io" type="number" value="10" class="w-full p-2 border rounded mt-1"></div>
                <div><label class="font-medium">Turns Ratio (K)</label><input id="k" type="number" value="3" class="w-full p-2 border rounded mt-1"></div>
                <div><label class="font-medium">Fill Factor (Ku)</label><input id="ku" type="number" value="0.4" step="0.01" class="w-full p-2 border rounded mt-1"></div>
                <div><label class="font-medium">Primary Wire Area (Sp, mm²)</label><input id="sp" type="number" value="0.518" class="w-full p-2 border rounded mt-1"></div>
                <div><label class="font-medium">Secondary Wire Area (Ss, mm²)</label><input id="ss" type="number" value="0.823" class="w-full p-2 border rounded mt-1"></div>
                <div><label class="font-medium">Window Area (Wa, mm²)</label><input id="wa" type="number" value="173" class="w-full p-2 border rounded mt-1"></div>
            </div>
            <div class="flex items-center gap-4">
                <button id="calculateBtn" class="ai-button bg-slate-700 hover:bg-slate-600">Calculate Parameters</button>
                <button id="aiBtn" class="ai-button" disabled>✨ Get AI Design Advice</button>
            </div>
            <div id="results" class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            <div id="aiAdvice" class="mt-6 p-4 bg-white rounded-lg border border-indigo-200" style="display: none;"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mt-8">
            <div class="md:col-span-2">
                
                <div class="card" data-section-name="Setting Limits">
                    <h2 id="limits">Setting Limits <button class="explain-button" onclick="getExplanation('limits')">✨ Explain</button></h2>
                    <p>The parametrization of the transformer is constrained by two critical limits: an upper limit defined by physical space and a lower limit determined by Faraday's law of induction. These ensure the design is both physically realizable and electrically sound.</p>
                    <h3 class="text-slate-700">Upper Limit: Maximum Number of Turns ($N_{pmax}$)</h3>
                    <div class="equation"><span id="eq4_50"></span><span class="equation-label">(4.50)</span></div>
                    <div class="equation"><span id="eq4_51"></span><span class="equation-label">(4.51)</span></div>
                    <h3 class="text-slate-700">Lower Limit: Minimum Number of Turns ($N_{pmin}$)</h3>
                    <div class="equation"><span id="eq4_52"></span><span class="equation-label">(4.52)</span></div>
                </div>

                <div class="card" data-section-name="Flux Density and Core Loss">
                    <h2 id="flux-density">Flux Density & Core Loss <button class="explain-button" onclick="getExplanation('flux-density')">✨ Explain</button></h2>
                    <p>The maximum permitted flux density ($B_{max}$) is a crucial parameter, calculated based on the core's allowable peak power loss ($P_{max}$). This value is determined by the core material's thermal resistance ($R_{th}$) and the maximum allowable temperature rise.</p>
                    <div class="equation"><span id="eq4_53"></span><span class="equation-label">(4.53)</span></div>
                    <div class="equation"><span id="eq4_54"></span><span class="equation-label">(4.54)</span></div>
                    <div class="equation"><span id="eq4_55"></span><span class="equation-label">(4.55)</span></div>
                </div>
                
                <div class="card" data-section-name="Series vs. Parallel Operation">
                    <h2 id="series-parallel">Series vs. Parallel <button class="explain-button" onclick="getExplanation('series-parallel')">✨ Explain</button></h2>
                    <p>The transformer's electrical conditions change based on its connection configuration, particularly affecting the voltage seen by each primary winding.</p>
                    <div class="equation"><span id="eq4_56"></span><span class="equation-label">(4.56)</span></div>
                </div>

                <div class="card" data-section-name="Turns Ratio">
                    <h2 id="turns-ratio">Turns Ratio (K) <button class="explain-button" onclick="getExplanation('turns-ratio')">✨ Explain</button></h2>
                    <p>The turns ratio is determined by the input and output voltage requirements for both series and parallel modes.</p>
                    <div class="equation"><span id="eq4_42"></span><span class="equation-label">(4.42)</span></div>
                    <div class="equation"><span id="eq4_43"></span><span class="equation-label">(4.43)</span></div>
                </div>

                <div class="card" data-section-name="Wire Size Selection">
                    <h2 id="wire-size">Wire Size Selection <button class="explain-button" onclick="getExplanation('wire-size')">✨ Explain</button></h2>
                    <p>Wire sizes are selected based on the RMS current they must carry. To mitigate high-frequency losses (like skin effect), Litz wire is often used.</p>
                    <div class="equation"><span id="eq4_47"></span><span class="equation-label">(4.47)</span></div>
                    <div class="equation"><span id="eq4_48"></span><span class="equation-label">(4.48)</span></div>
                    <div class="equation"><span id="eq4_49"></span><span class="equation-label">(4.49)</span></div>
                </div>

                <div class="explanation-section">
                    <h2>Interpretation of Interactive Plots</h2>
                    [cite_start]<p>The interactive plots generated by this tool provide crucial insights into the transformer's performance under various operating conditions and design choices. [cite: 45] [cite_start]By manipulating the input parameters, you can visualize the impact on key metrics: [cite: 45]</p>

                    <h3>Core Loss vs. Flux Density / Turns:</h3>
                    [cite_start]<p>These plots illustrate the relationship between the chosen core material's losses and the operating flux density or number of turns. [cite: 46] [cite_start]Lower core losses are generally desirable, but they often come at the expense of requiring more turns (larger transformer size) or a larger core. [cite: 47] [cite_start]The curve helps identify the optimal operating point for minimizing core losses for a selected core type. [cite: 47]</p>
                    <h3>Copper Loss vs. Turns:</h3>
                    [cite_start]<p>This plot shows how copper losses vary with the number of primary turns. [cite: 48] [cite_start]As turns increase, the wire length increases, raising DC resistance. [cite: 49] [cite_start]However, the skin and proximity effects (which are complexly modeled in the JavaScript) also play a significant role. [cite: 50] [cite_start]The goal is to find a balance where copper losses are minimized for a given power level and frequency. [cite: 50]</p>
                    <h3>Total Power Loss vs. Flux Density / Turns:</h3>
                    [cite_start]<p>These are the most critical plots as they represent the combined impact of all losses. [cite: 51] [cite_start]The objective is to identify the number of turns (or corresponding flux density) that results in the lowest total power loss, while also ensuring the total loss remains below the maximum allowable power loss for the core's thermal limits (represented by the $P_{max}$ line in the plots). [cite: 51]</p>
                    <h3>Ku Factor vs. Turns:</h3>
                    [cite_start]<p>The Ku factor (Window Utilization Factor) is a measure of how effectively the winding window area of the core is utilized by the copper windings. [cite: 52] [cite_start]A higher Ku factor indicates a more compact and efficient winding design. [cite: 53] [cite_start]This plot helps in understanding the space efficiency of the windings for different turn counts. [cite: 53]</p>
                    <h3>Skeff & Proximity Effects:</h3>
                    [cite_start]<p>This plot (if enabled) visualizes the skin effect factor ($S_{keff}$) and proximity effect factor ($F_R$) for different wire sizes or frequencies. [cite: 54] [cite_start]Understanding these effects is vital for selecting appropriate Litz wire constructions to minimize high-frequency copper losses. [cite: 54]</p>
                    <h3>Core Loss Comparison:</h3>
                    [cite_start]<p>The "Loss Difference Summary Table for All Cores" (generated below the plot) provides a quick comparison of the optimal power loss for different core types. [cite: 55] [cite_start]This helps in selecting the most thermally efficient core for your application based on your specified constraints. [cite: 55]</p>
                </div>

            </div>

            <div class="md:col-span-1">
                <div class="card sticky top-8">
                    <h2 id="fill-factor-graph">Fill Factor ($K_u$) Trend</h2>
                    <canvas id="fillFactorChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div id="aiModal" class="modal-backdrop" style="display: none;">
        <div class="modal-content">
            <h3 id="modalTitle" class="text-2xl font-bold text-slate-800 mb-4"></h3>
            <div id="modalBody"></div>
            <button onclick="closeModal()" class="mt-6 w-full ai-button">Close</button>
        </div>
    </div>


    <script>
        // --- GEMINI API CALLER ---
        async function callGemini(prompt) {
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = ""; // API key is handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    return "Sorry, I couldn't get a response. The response from the AI was empty or malformed.";
                }
            } catch (error) {
                console.error("Gemini API call error:", error);
                return `Sorry, an error occurred while contacting the AI advisor: ${error.message}`;
            }
        }

        // --- UI & MODAL LOGIC ---
        function showModal(title, body) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = body;
            document.getElementById('aiModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('aiModal').style.display = 'none';
        }

        async function getExplanation(sectionId) {
            const sectionCard = document.getElementById(sectionId).closest('.card');
            const sectionName = sectionCard.dataset.sectionName;
            const sectionText = sectionCard.innerText.replace('✨ Explain','').trim();
            
            showModal(`✨ Explaining: ${sectionName}`, '<div class="flex justify-center items-center p-8"><div class="loader"></div></div>');

            const prompt = `As an expert in power electronics, please explain the following concept from a transformer design document in a clear, simple, and conversational way for an engineering student. Explain the significance of the formulas and the practical implications.
            
            Concept: "${sectionName}"
            
            Text from document: "${sectionText}"`;

            const explanation = await callGemini(prompt);
            showModal(`✨ Explaining: ${sectionName}`, explanation.replace(/\n/g, '<br>'));
        }

        // --- CALCULATOR LOGIC ---
        document.getElementById('calculateBtn').addEventListener('click', () => {
            // Get all input values
            const Vin = parseFloat(document.getElementById('vin').value);
            const D = parseFloat(document.getElementById('d').value);
            const fs = parseFloat(document.getElementById('fs').value) * 1000; // to Hz
            const Ac = parseFloat(document.getElementById('ac').value) / 1000000; // to m^2
            const Bmax = parseFloat(document.getElementById('bmax').value);
            const Io = parseFloat(document.getElementById('io').value);
            const K = parseFloat(document.getElementById('k').value);
            const Ku = parseFloat(document.getElementById('ku').value);
            const Sp = parseFloat(document.getElementById('sp').value) / 1000000; // to m^2
            const Ss = parseFloat(document.getElementById('ss').value) / 1000000; // to m^2
            const Wa = parseFloat(document.getElementById('wa').value) / 1000000; // to m^2

            // Perform calculations
            const Npmin = (Vin * D) / (2 * fs * Ac * Bmax);
            const Npmax = (Ku * Wa) / (Sp + Ss / K);
            const Iprms = (Io / (2 * (1 / K))) * Math.sqrt(2 * D);
            const Isrms = (Io / 2) * Math.sqrt(D);

            // Display results
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="p-3 bg-slate-100 rounded-lg"><span class="font-medium">Min Primary Turns (Npmin):</span><br>${Npmin.toFixed(2)}</div>
                <div class="p-3 bg-slate-100 rounded-lg"><span class="font-medium">Max Primary Turns (Npmax):</span><br>${Npmax.toFixed(2)}</div>
                <div class="p-3 bg-slate-100 rounded-lg"><span class="font-medium">Primary RMS Current (A):</span><br>${Iprms.toFixed(2)}</div>
                <div class="p-3 bg-slate-100 rounded-lg"><span class="font-medium">Secondary RMS Current (A):</span><br>${Isrms.toFixed(2)}</div>
            `;

            // Enable AI button
            document.getElementById('aiBtn').disabled = false;
        });
        
        document.getElementById('aiBtn').addEventListener('click', async () => {
            const aiBtn = document.getElementById('aiBtn');
            const adviceDiv = document.getElementById('aiAdvice');
            
            aiBtn.disabled = true;
            aiBtn.innerHTML = '<div class="loader"></div>';
            adviceDiv.style.display = 'block';
            adviceDiv.innerHTML = '<div class="flex justify-center items-center p-8"><div class="loader" style="border-color: #4f46e5; border-bottom-color: transparent;"></div></div>';

            const inputs = {
                Vin: document.getElementById('vin').value,
                D: document.getElementById('d').value,
                fs: document.getElementById('fs').value,
                Ac: document.getElementById('ac').value,
                Bmax: document.getElementById('bmax').value,
                Io: document.getElementById('io').value,
                K: document.getElementById('k').value,
                Ku: document.getElementById('ku').value,
                Sp: document.getElementById('sp').value,
                Ss: document.getElementById('ss').value,
                Wa: document.getElementById('wa').value,
                results: document.getElementById('results').innerText
            };

            const prompt = `I am an engineering student designing a high-frequency transformer. Please act as an expert power electronics design consultant and provide advice based on my parameters.

            My Input Parameters:
            - Input Voltage (Vin): ${inputs.Vin} V
            - Duty Cycle (D): ${inputs.D}
            - Switching Frequency (fs): ${inputs.fs} kHz
            - Core Area (Ac): ${inputs.Ac} mm^2
            - Max Flux Density (Bmax): ${inputs.Bmax} T
            - Output Current (Io): ${inputs.Io} A
            - Turns Ratio (K): ${inputs.K}
            - Fill Factor (Ku): ${inputs.Ku}
            - Primary Wire Area (Sp): ${inputs.Sp} mm^2
            - Secondary Wire Area (Ss): ${inputs.Ss} mm^2
            - Core Window Area (Wa): ${inputs.Wa} mm^2

            My Calculated Results:
            ${inputs.results}

            Based on all this information, please provide a concise analysis covering:
            1.  **Feasibility Check:** Is the design window (Npmin to Npmax) reasonable? If it's too narrow or if Npmin > Npmax, what are the likely causes and solutions?
            2.  **Core & Winding:** Comment on the flux density. Is it a conservative or aggressive value for this frequency? What are the implications for core loss?
            3.  **Potential Challenges:** What are the biggest challenges I might face with this design (e.g., thermal issues, high-frequency losses, manufacturability)?
            4.  **Recommendations:** Suggest one or two concrete actions I could take to improve or optimize this design.`;
            
            const advice = await callGemini(prompt);
            adviceDiv.innerHTML = advice.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            aiBtn.disabled = false;
            aiBtn.innerHTML = '✨ Get AI Design Advice';
        });

        // --- INITIALIZATION ---
        window.onload = function() {
            // KaTeX rendering for equations
            const equations = {
                'eq4_50': 'K_u \\cdot W_a = N_p S_p + N_s S_s',
                'eq4_51': 'N_{pmax} \\le \\frac{K_u \\cdot W_a}{S_p + \\frac{S_s}{K}}',
                'eq4_52': 'N_{pmin} = \\frac{V_{in} \\cdot D}{2 f_s A_c B_{max}}',
                'eq4_53': 'P_{max} = \\frac{T_{max} - T_{min}}{R_{th}}',
                'eq4_54': 'R_{th} = 53 \\cdot (V_{core})^{-0.54}',
                'eq4_55': 'B_{max} = \\left( \\frac{P_{max}}{k f^{\\alpha} V_{core}} \\right)^{\\frac{1}{\\beta}}',
                'eq4_56': 'B = \\frac{V_{in} \\cdot D}{2 \\cdot A_c f_s N}',
                'eq4_42': 'V_{out(series)} = 2 \\cdot D_{eff} \\cdot \\frac{N_s}{N_p} \\cdot \\frac{V_{in}}{2}',
                'eq4_43': 'V_{out(parallel)} = 2 \\cdot D_{eff} \\cdot \\frac{N_s}{N_p} \\cdot V_{in}',
                'eq4_47': 'I_{prms} = \\frac{I_o}{2 \\cdot \\frac{N_s}{N_p}} \\cdot \\sqrt{2D}',
                'eq4_48': 'I_{srms} = \\frac{I_o}{2} \\cdot \\sqrt{D}',
                'eq4_49': 'd = \\sqrt{\\frac{4 I_{max}}{7.2 \\cdot \\pi}}',
                // New equations from the fetched file
                'eq_Np': 'N_p = \\frac{V_{in}}{2 \\cdot f \\cdot B_{max} \\cdot A_e}',
                'eq_n': 'n = \\frac{V_{primary, RMS}}{V_{secondary, RMS}} \\approx \\frac{V_{in, nominal}}{V_{out, desired} + V_{diode\\_drop}}',
                'eq_Pcore': 'P_{core} = k \\cdot f^{\\alpha} \\cdot B_{ac}^{\\beta} \\cdot V_e',
                'eq_Pcopper': 'P_{copper} = I_{rms}^2 \\cdot R_{ac}',
                'eq_Rac': 'R_{ac} = F_R \\cdot R_{dc}',
                'eq_Ptotalloss': 'P_{total\\_loss} = P_{core} + P_{copper}'
            };
            for (const id in equations) {
                katex.render(equations[id], document.getElementById(id), { throwOnError: false, displayMode: true });
            }
            
            // Chart.js for animated graph
            const ctx = document.getElementById('fillFactorChart').getContext('2d');
            const chartData = {
                labels: [0, 100, 200, 300, 400, 500, 600, 700, 800],
                datasets: [
                    { label: 'EE19', data: [0.45, 0.42, 0.39, null], borderColor: '#36A2EB', fill: false, tension: 0.1 },
                    { label: 'EE25/19', data: [0.52, 0.49, 0.46, 0.43], borderColor: '#FF6384', fill: false, tension: 0.1 },
                    { label: 'EE40', data: [0.56, 0.54, 0.52, 0.50, 0.48, 0.46], borderColor: '#4BC0C0', fill: false, tension: 0.1 },
                    { label: 'EE50', data: [0.58, 0.56, 0.54, 0.52, 0.50, 0.48, 0.46, 0.44, 0.42], borderColor: '#FF9F40', fill: false, tension: 0.1 },
                    { label: 'EE55', data: [0.60, 0.58, 0.56, 0.54, 0.52, 0.50, 0.48, 0.46, 0.44], borderColor: '#E63946', fill: false, tension: 0.1 }
                ]
            };
            new Chart(ctx, {
                type: 'line', data: chartData, options: { responsive: true, animation: { duration: 2000, easing: 'easeInOutQuad' }, scales: { x: { title: { display: true, text: 'Number of Turns' } }, y: { title: { display: true, text: 'Window Utilization Factor (Ku)' }, min: 0.3, max: 0.6 } }, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Fill Factor Trend vs. Number of Turns' } } }
            });
        };
    </script>
</body>
</html>
